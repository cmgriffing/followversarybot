import{g as Ue,c as ue,b as ge}from"./index.e6406684.js";var Re={exports:{}};const He={},We=Object.freeze(Object.defineProperty({__proto__:null,default:He},Symbol.toStringTag,{value:"Module"})),pe=Ue(We);var Ie={exports:{}};const Fe=/^\u0001ACTION ([^\u0001]+)\u0001$/,Je=/^(justinfan)(\d+$)/,Ye=/\\([sn:r\\])/g,qe=/([ \n;\r\\])/g,be={s:" ",n:"",":":";",r:""},ve={" ":"s","\n":"n",";":":","\r":"r"},Ge=new RegExp("^(?:(?:https?|ftp)://)(?:\\S+(?::\\S*)?@)?(?:(?!(?:10|127)(?:\\.\\d{1,3}){3})(?!(?:169\\.254|192\\.168)(?:\\.\\d{1,3}){2})(?!172\\.(?:1[6-9]|2\\d|3[0-1])(?:\\.\\d{1,3}){2})(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[1-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]-*)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))\\.?)(?::\\d{2,5})?(?:[/?#]\\S*)?$","i"),Ve=/[|\\^$*+?:#]/,le=Ie.exports={get:(e,t)=>typeof e>"u"?t:e,hasOwn:(e,t)=>({}).hasOwnProperty.call(e,t),promiseDelay:e=>new Promise(t=>setTimeout(t,e)),isFinite:e=>isFinite(e)&&!isNaN(parseFloat(e)),toNumber(e,t){if(e===null)return 0;const s=Math.pow(10,le.isFinite(t)?t:0);return Math.round(e*s)/s},isInteger:e=>!isNaN(le.toNumber(e,0)),isRegex:e=>Ve.test(e),isURL:e=>Ge.test(e),justinfan:()=>`justinfan${Math.floor(Math.random()*8e4+1e3)}`,isJustinfan:e=>Je.test(e),channel(e){const t=(e||"").toLowerCase();return t[0]==="#"?t:"#"+t},username(e){const t=(e||"").toLowerCase();return t[0]==="#"?t.slice(1):t},token:e=>e?e.toLowerCase().replace("oauth:",""):"",password(e){const t=le.token(e);return t?`oauth:${t}`:""},actionMessage:e=>e.match(Fe),replaceAll(e,t){if(e===null||typeof e>"u")return null;for(const s in t)e=e.replace(new RegExp(s,"g"),t[s]);return e},unescapeHtml:e=>e.replace(/\\&amp\\;/g,"&").replace(/\\&lt\\;/g,"<").replace(/\\&gt\\;/g,">").replace(/\\&quot\\;/g,'"').replace(/\\&#039\\;/g,"'"),unescapeIRC(e){return!e||typeof e!="string"||!e.includes("\\")?e:e.replace(Ye,(t,s)=>s in be?be[s]:s)},escapeIRC(e){return!e||typeof e!="string"?e:e.replace(qe,(t,s)=>s in ve?`\\${ve[s]}`:s)},addWord:(e,t)=>e.length?e+" "+t:e+t,splitLine(e,t){let s=e.substring(0,t).lastIndexOf(" ");return s===-1&&(s=t-1),[e.substring(0,s),e.substring(s+1)]},extractNumber(e){const t=e.split(" ");for(let s=0;s<t.length;s++)if(le.isInteger(t[s]))return~~t[s];return 0},formatDate(e){let t=e.getHours(),s=e.getMinutes();return t=(t<10?"0":"")+t,s=(s<10?"0":"")+s,`${t}:${s}`},inherits(e,t){e.super_=t;const s=function(){};s.prototype=t.prototype,e.prototype=new s,e.prototype.constructor=e},isNode(){try{return typeof process=="object"&&Object.prototype.toString.call(process)==="[object process]"}catch{}return!1}};var re=Ie.exports;const ze=pe,we=re;var Be=function(t,s){let i=t.url!==void 0?t.url:t.uri;if(we.isURL(i)||(i=`https://api.twitch.tv/kraken${i[0]==="/"?i:`/${i}`}`),we.isNode()){const o=Object.assign({method:"GET",json:!0},t);if(o.qs){const g=new URLSearchParams(o.qs);i+=`?${g}`}const a={};"fetchAgent"in this.opts.connection&&(a.agent=this.opts.connection.fetchAgent);const u=ze(i,{...a,method:o.method,headers:o.headers,body:o.body});let p={};u.then(g=>(p={statusCode:g.status,headers:g.headers},o.json?g.json():g.text())).then(g=>s(null,p,g),g=>s(g,p,null))}else{const o=Object.assign({method:"GET",headers:{}},t,{url:i}),a=new XMLHttpRequest;a.open(o.method,o.url,!0);for(const u in o.headers)a.setRequestHeader(u,o.headers[u]);a.responseType="json",a.addEventListener("load",u=>{a.readyState===4&&(a.status!==200?s(a.status,null,null):s(null,null,a.response))}),a.send()}};const $=re;function ye(e,t){return e=$.channel(e),t=$.get(t,30),this._sendCommand(null,e,`/followers ${t}`,(s,i)=>{this.once("_promiseFollowers",o=>{o?i(o):s([e,~~t])})})}function $e(e){return e=$.channel(e),this._sendCommand(null,e,"/followersoff",(t,s)=>{this.once("_promiseFollowersoff",i=>{i?s(i):t([e])})})}function Ce(e){return e=$.channel(e),this._sendCommand(null,null,`PART ${e}`,(t,s)=>{this.once("_promisePart",i=>{i?s(i):t([e])})})}function ke(e){return e=$.channel(e),this._sendCommand(null,e,"/r9kbeta",(t,s)=>{this.once("_promiseR9kbeta",i=>{i?s(i):t([e])})})}function Te(e){return e=$.channel(e),this._sendCommand(null,e,"/r9kbetaoff",(t,s)=>{this.once("_promiseR9kbetaoff",i=>{i?s(i):t([e])})})}function Se(e,t){return e=$.channel(e),t=$.get(t,300),this._sendCommand(null,e,`/slow ${t}`,(s,i)=>{this.once("_promiseSlow",o=>{o?i(o):s([e,~~t])})})}function xe(e){return e=$.channel(e),this._sendCommand(null,e,"/slowoff",(t,s)=>{this.once("_promiseSlowoff",i=>{i?s(i):t([e])})})}var Qe={action(e,t){return e=$.channel(e),t=`ACTION ${t}`,this._sendMessage(this._getPromiseDelay(),e,t,(s,i)=>{s([e,t])})},ban(e,t,s){return e=$.channel(e),t=$.username(t),s=$.get(s,""),this._sendCommand(null,e,`/ban ${t} ${s}`,(i,o)=>{this.once("_promiseBan",a=>{a?o(a):i([e,t,s])})})},clear(e){return e=$.channel(e),this._sendCommand(null,e,"/clear",(t,s)=>{this.once("_promiseClear",i=>{i?s(i):t([e])})})},color(e,t){return t=$.get(t,e),this._sendCommand(null,"#tmijs",`/color ${t}`,(s,i)=>{this.once("_promiseColor",o=>{o?i(o):s([t])})})},commercial(e,t){return e=$.channel(e),t=$.get(t,30),this._sendCommand(null,e,`/commercial ${t}`,(s,i)=>{this.once("_promiseCommercial",o=>{o?i(o):s([e,~~t])})})},deletemessage(e,t){return e=$.channel(e),this._sendCommand(null,e,`/delete ${t}`,(s,i)=>{this.once("_promiseDeletemessage",o=>{o?i(o):s([e])})})},emoteonly(e){return e=$.channel(e),this._sendCommand(null,e,"/emoteonly",(t,s)=>{this.once("_promiseEmoteonly",i=>{i?s(i):t([e])})})},emoteonlyoff(e){return e=$.channel(e),this._sendCommand(null,e,"/emoteonlyoff",(t,s)=>{this.once("_promiseEmoteonlyoff",i=>{i?s(i):t([e])})})},followersonly:ye,followersmode:ye,followersonlyoff:$e,followersmodeoff:$e,host(e,t){return e=$.channel(e),t=$.username(t),this._sendCommand(2e3,e,`/host ${t}`,(s,i)=>{this.once("_promiseHost",(o,a)=>{o?i(o):s([e,t,~~a])})})},join(e){return e=$.channel(e),this._sendCommand(void 0,null,`JOIN ${e}`,(t,s)=>{const i="_promiseJoin";let o=!1;const a=(p,g)=>{e===$.channel(g)&&(this.removeListener(i,a),o=!0,p?s(p):t([e]))};this.on(i,a);const u=this._getPromiseDelay();$.promiseDelay(u).then(()=>{o||this.emit(i,"No response from Twitch.",e)})})},mod(e,t){return e=$.channel(e),t=$.username(t),this._sendCommand(null,e,`/mod ${t}`,(s,i)=>{this.once("_promiseMod",o=>{o?i(o):s([e,t])})})},mods(e){return e=$.channel(e),this._sendCommand(null,e,"/mods",(t,s)=>{this.once("_promiseMods",(i,o)=>{i?s(i):(o.forEach(a=>{this.moderators[e]||(this.moderators[e]=[]),this.moderators[e].includes(a)||this.moderators[e].push(a)}),t(o))})})},part:Ce,leave:Ce,ping(){return this._sendCommand(null,null,"PING",(e,t)=>{this.latency=new Date,this.pingTimeout=setTimeout(()=>{this.ws!==null&&(this.wasCloseCalled=!1,this.log.error("Ping timeout."),this.ws.close(),clearInterval(this.pingLoop),clearTimeout(this.pingTimeout))},$.get(this.opts.connection.timeout,9999)),this.once("_promisePing",s=>e([parseFloat(s)]))})},r9kbeta:ke,r9kmode:ke,r9kbetaoff:Te,r9kmodeoff:Te,raw(e){return this._sendCommand(null,null,e,(t,s)=>{t([e])})},say(e,t){return e=$.channel(e),t.startsWith(".")&&!t.startsWith("..")||t.startsWith("/")||t.startsWith("\\")?t.substr(1,3)==="me "?this.action(e,t.substr(4)):this._sendCommand(null,e,t,(s,i)=>{s([e,t])}):this._sendMessage(this._getPromiseDelay(),e,t,(s,i)=>{s([e,t])})},slow:Se,slowmode:Se,slowoff:xe,slowmodeoff:xe,subscribers(e){return e=$.channel(e),this._sendCommand(null,e,"/subscribers",(t,s)=>{this.once("_promiseSubscribers",i=>{i?s(i):t([e])})})},subscribersoff(e){return e=$.channel(e),this._sendCommand(null,e,"/subscribersoff",(t,s)=>{this.once("_promiseSubscribersoff",i=>{i?s(i):t([e])})})},timeout(e,t,s,i){return e=$.channel(e),t=$.username(t),s!==null&&!$.isInteger(s)&&(i=s,s=300),s=$.get(s,300),i=$.get(i,""),this._sendCommand(null,e,`/timeout ${t} ${s} ${i}`,(o,a)=>{this.once("_promiseTimeout",u=>{u?a(u):o([e,t,~~s,i])})})},unban(e,t){return e=$.channel(e),t=$.username(t),this._sendCommand(null,e,`/unban ${t}`,(s,i)=>{this.once("_promiseUnban",o=>{o?i(o):s([e,t])})})},unhost(e){return e=$.channel(e),this._sendCommand(2e3,e,"/unhost",(t,s)=>{this.once("_promiseUnhost",i=>{i?s(i):t([e])})})},unmod(e,t){return e=$.channel(e),t=$.username(t),this._sendCommand(null,e,`/unmod ${t}`,(s,i)=>{this.once("_promiseUnmod",o=>{o?i(o):s([e,t])})})},unvip(e,t){return e=$.channel(e),t=$.username(t),this._sendCommand(null,e,`/unvip ${t}`,(s,i)=>{this.once("_promiseUnvip",o=>{o?i(o):s([e,t])})})},vip(e,t){return e=$.channel(e),t=$.username(t),this._sendCommand(null,e,`/vip ${t}`,(s,i)=>{this.once("_promiseVip",o=>{o?i(o):s([e,t])})})},vips(e){return e=$.channel(e),this._sendCommand(null,e,"/vips",(t,s)=>{this.once("_promiseVips",(i,o)=>{i?s(i):t(o)})})},whisper(e,t){return e=$.username(e),e===this.getUsername()?Promise.reject("Cannot send a whisper to the same account."):this._sendCommand(null,"#tmijs",`/w ${e} ${t}`,(s,i)=>{this.once("_promiseWhisper",o=>{o&&i(o)})}).catch(s=>{if(s&&typeof s=="string"&&s.indexOf("No response from Twitch.")!==0)throw s;const i=$.channel(e),o=Object.assign({"message-type":"whisper","message-id":null,"thread-id":null,username:this.getUsername()},this.globaluserstate);return this.emits(["whisper","message"],[[i,o,t,!0],[i,o,t,!0]]),[e,t]})}};function U(){this._events=this._events||{},this._maxListeners=this._maxListeners||void 0}var Ze=U;U.EventEmitter=U;U.prototype._events=void 0;U.prototype._maxListeners=void 0;U.defaultMaxListeners=10;U.prototype.setMaxListeners=function(e){if(!Xe(e)||e<0||isNaN(e))throw TypeError("n must be a positive number");return this._maxListeners=e,this};U.prototype.emit=function(e){var t,s,i,o,a,u;if(this._events||(this._events={}),e==="error"&&(!this._events.error||ne(this._events.error)&&!this._events.error.length))throw t=arguments[1],t instanceof Error?t:TypeError('Uncaught, unspecified "error" event.');if(s=this._events[e],Ne(s))return!1;if(G(s))switch(arguments.length){case 1:s.call(this);break;case 2:s.call(this,arguments[1]);break;case 3:s.call(this,arguments[1],arguments[2]);break;default:o=Array.prototype.slice.call(arguments,1),s.apply(this,o)}else if(ne(s))for(o=Array.prototype.slice.call(arguments,1),u=s.slice(),i=u.length,a=0;a<i;a++)u[a].apply(this,o);return!0};U.prototype.addListener=function(e,t){var s;if(!G(t))throw TypeError("listener must be a function");return this._events||(this._events={}),this._events.newListener&&this.emit("newListener",e,G(t.listener)?t.listener:t),this._events[e]?ne(this._events[e])?this._events[e].push(t):this._events[e]=[this._events[e],t]:this._events[e]=t,ne(this._events[e])&&!this._events[e].warned&&(Ne(this._maxListeners)?s=U.defaultMaxListeners:s=this._maxListeners,s&&s>0&&this._events[e].length>s&&(this._events[e].warned=!0,console.error("(node) warning: possible EventEmitter memory leak detected. %d listeners added. Use emitter.setMaxListeners() to increase limit.",this._events[e].length),typeof console.trace=="function"&&console.trace())),this};U.prototype.on=U.prototype.addListener;U.prototype.once=function(e,t){if(!G(t))throw TypeError("listener must be a function");var s=!1;if(this._events.hasOwnProperty(e)&&e.charAt(0)==="_"){var i=1,o=e;for(var a in this._events)this._events.hasOwnProperty(a)&&a.startsWith(o)&&i++;e=e+i}function u(){e.charAt(0)==="_"&&!isNaN(e.substr(e.length-1))&&(e=e.substring(0,e.length-1)),this.removeListener(e,u),s||(s=!0,t.apply(this,arguments))}return u.listener=t,this.on(e,u),this};U.prototype.removeListener=function(e,t){var s,i,o,a;if(!G(t))throw TypeError("listener must be a function");if(!this._events||!this._events[e])return this;if(s=this._events[e],o=s.length,i=-1,s===t||G(s.listener)&&s.listener===t){if(delete this._events[e],this._events.hasOwnProperty(e+"2")&&e.charAt(0)==="_"){var u=e;for(var p in this._events)this._events.hasOwnProperty(p)&&p.startsWith(u)&&(isNaN(parseInt(p.substr(p.length-1)))||(this._events[e+parseInt(p.substr(p.length-1)-1)]=this._events[p],delete this._events[p]));this._events[e]=this._events[e+"1"],delete this._events[e+"1"]}this._events.removeListener&&this.emit("removeListener",e,t)}else if(ne(s)){for(a=o;a-- >0;)if(s[a]===t||s[a].listener&&s[a].listener===t){i=a;break}if(i<0)return this;s.length===1?(s.length=0,delete this._events[e]):s.splice(i,1),this._events.removeListener&&this.emit("removeListener",e,t)}return this};U.prototype.removeAllListeners=function(e){var t,s;if(!this._events)return this;if(!this._events.removeListener)return arguments.length===0?this._events={}:this._events[e]&&delete this._events[e],this;if(arguments.length===0){for(t in this._events)t!=="removeListener"&&this.removeAllListeners(t);return this.removeAllListeners("removeListener"),this._events={},this}if(s=this._events[e],G(s))this.removeListener(e,s);else if(s)for(;s.length;)this.removeListener(e,s[s.length-1]);return delete this._events[e],this};U.prototype.listeners=function(e){var t;return!this._events||!this._events[e]?t=[]:G(this._events[e])?t=[this._events[e]]:t=this._events[e].slice(),t};U.prototype.listenerCount=function(e){if(this._events){var t=this._events[e];if(G(t))return 1;if(t)return t.length}return 0};U.listenerCount=function(e,t){return e.listenerCount(t)};function G(e){return typeof e=="function"}function Xe(e){return typeof e=="number"}function ne(e){return typeof e=="object"&&e!==null}function Ne(e){return e===void 0}const Ke=re;let Ae="info";const Ee={trace:0,debug:1,info:2,warn:3,error:4,fatal:5};function Z(e){return function(t){Ee[e]>=Ee[Ae]&&console.log(`[${Ke.formatDate(new Date)}] ${e}: ${t}`)}}var et={setLevel(e){Ae=e},trace:Z("trace"),debug:Z("debug"),info:Z("info"),warn:Z("warn"),error:Z("error"),fatal:Z("fatal")};const fe=re,X=/\S+/g;function me(e,t,s=",",i="/",o){const a=e[t];if(a===void 0)return e;const u=typeof a=="string";if(e[t+"-raw"]=u?a:null,a===!0)return e[t]=null,e;if(e[t]={},u){const p=a.split(s);for(let g=0;g<p.length;g++){const D=p[g].split(i);let h=D[1];o!==void 0&&h&&(h=h.split(o)),e[t][D[0]]=h||null}}return e}var tt={badges:e=>me(e,"badges"),badgeInfo:e=>me(e,"badge-info"),emotes:e=>me(e,"emotes","/",":",","),emoteRegex(e,t,s,i){X.lastIndex=0;const o=new RegExp("(\\b|^|\\s)"+fe.unescapeHtml(t)+"(\\b|$|\\s)");let a;for(;(a=X.exec(e))!==null;)o.test(a[0])&&(i[s]=i[s]||[],i[s].push([a.index,X.lastIndex-1]))},emoteString(e,t,s,i){X.lastIndex=0;let o;for(;(o=X.exec(e))!==null;)o[0]===fe.unescapeHtml(t)&&(i[s]=i[s]||[],i[s].push([o.index,X.lastIndex-1]))},transformEmotes(e){let t="";return Object.keys(e).forEach(s=>{t=`${t+s}:`,e[s].forEach(i=>t=`${t+i.join("-")},`),t=`${t.slice(0,-1)}/`}),t.slice(0,-1)},formTags(e){const t=[];for(const s in e){const i=fe.escapeIRC(e[s]);t.push(`${s}=${i}`)}return`@${t.join(";")}`},msg(e){const t={raw:e,tags:{},prefix:null,command:null,params:[]};let s=0,i=0;if(e.charCodeAt(0)===64){if(i=e.indexOf(" "),i===-1)return null;const o=e.slice(1,i).split(";");for(let a=0;a<o.length;a++){const u=o[a],p=u.split("=");t.tags[p[0]]=u.substring(u.indexOf("=")+1)||!0}s=i+1}for(;e.charCodeAt(s)===32;)s++;if(e.charCodeAt(s)===58){if(i=e.indexOf(" ",s),i===-1)return null;for(t.prefix=e.slice(s+1,i),s=i+1;e.charCodeAt(s)===32;)s++}if(i=e.indexOf(" ",s),i===-1)return e.length>s?(t.command=e.slice(s),t):null;for(t.command=e.slice(s,i),s=i+1;e.charCodeAt(s)===32;)s++;for(;s<e.length;){if(i=e.indexOf(" ",s),e.charCodeAt(s)===58){t.params.push(e.slice(s+1));break}if(i!==-1){for(t.params.push(e.slice(s,i)),s=i+1;e.charCodeAt(s)===32;)s++;continue}if(i===-1){t.params.push(e.slice(s));break}}return t}};class st{constructor(t){this.queue=[],this.index=0,this.defaultDelay=t===void 0?3e3:t}add(t,s){this.queue.push({fn:t,delay:s})}next(){const t=this.index++,s=this.queue[t];if(!s)return;const i=this.queue[this.index];if(s.fn(),i){const o=i.delay===void 0?this.defaultDelay:i.delay;setTimeout(()=>this.next(),o)}}}var it=st;(function(e){const t=typeof ue<"u"?ue:typeof window<"u"?window:{},s=t.WebSocket||pe,i=t.fetch||pe,o=Be,a=Qe,u=Ze.EventEmitter,p=et,g=tt,D=it,h=re;let L=!1;const T=function S(r){if(!(this instanceof S))return new S(r);this.opts=h.get(r,{}),this.opts.channels=this.opts.channels||[],this.opts.connection=this.opts.connection||{},this.opts.identity=this.opts.identity||{},this.opts.options=this.opts.options||{},this.clientId=h.get(this.opts.options.clientId,null),this._globalDefaultChannel=h.channel(h.get(this.opts.options.globalDefaultChannel,"#tmijs")),this._skipMembership=h.get(this.opts.options.skipMembership,!1),this._skipUpdatingEmotesets=h.get(this.opts.options.skipUpdatingEmotesets,!1),this._updateEmotesetsTimer=null,this._updateEmotesetsTimerDelay=h.get(this.opts.options.updateEmotesetsTimer,6e4),this.maxReconnectAttempts=h.get(this.opts.connection.maxReconnectAttempts,1/0),this.maxReconnectInterval=h.get(this.opts.connection.maxReconnectInterval,3e4),this.reconnect=h.get(this.opts.connection.reconnect,!0),this.reconnectDecay=h.get(this.opts.connection.reconnectDecay,1.5),this.reconnectInterval=h.get(this.opts.connection.reconnectInterval,1e3),this.reconnecting=!1,this.reconnections=0,this.reconnectTimer=this.reconnectInterval,this.secure=h.get(this.opts.connection.secure,!this.opts.connection.server&&!this.opts.connection.port),this.emotes="",this.emotesets={},this.channels=[],this.currentLatency=0,this.globaluserstate={},this.lastJoined="",this.latency=new Date,this.moderators={},this.pingLoop=null,this.pingTimeout=null,this.reason="",this.username="",this.userstate={},this.wasCloseCalled=!1,this.ws=null;let n="error";this.opts.options.debug&&(n="info"),this.log=this.opts.logger||p;try{p.setLevel(n)}catch{}this.opts.channels.forEach((c,w,b)=>b[w]=h.channel(c)),u.call(this),this.setMaxListeners(0)};h.inherits(T,u);for(const S in a)T.prototype[S]=a[S];T.prototype.emits=function(r,n){for(let c=0;c<r.length;c++){const w=c<n.length?n[c]:n[n.length-1];this.emit.apply(this,[r[c]].concat(w))}},T.prototype.api=function(...S){L||(this.log.warn("Client.prototype.api is deprecated and will be removed for version 2.0.0"),L=!0),o(...S)},T.prototype.handleMessage=function(r){if(!r)return;this.listenerCount("raw_message")&&this.emit("raw_message",JSON.parse(JSON.stringify(r)),r);const n=h.channel(h.get(r.params[0],null));let c=h.get(r.params[1],null);const w=h.get(r.tags["msg-id"],null),b=r.tags=g.badges(g.badgeInfo(g.emotes(r.tags)));for(const l in b){if(l==="emote-sets"||l==="ban-duration"||l==="bits")continue;let m=b[l];typeof m=="boolean"?m=null:m==="1"?m=!0:m==="0"?m=!1:typeof m=="string"&&(m=h.unescapeIRC(m)),b[l]=m}if(r.prefix===null)switch(r.command){case"PING":this.emit("ping"),this._isConnected()&&this.ws.send("PONG");break;case"PONG":{const l=new Date;this.currentLatency=(l.getTime()-this.latency.getTime())/1e3,this.emits(["pong","_promisePing"],[[this.currentLatency]]),clearTimeout(this.pingTimeout);break}default:this.log.warn(`Could not parse message with no prefix:
${JSON.stringify(r,null,4)}`);break}else if(r.prefix==="tmi.twitch.tv")switch(r.command){case"002":case"003":case"004":case"372":case"375":case"CAP":break;case"001":this.username=r.params[0];break;case"376":{this.log.info("Connected to server."),this.userstate[this._globalDefaultChannel]={},this.emits(["connected","_promiseConnect"],[[this.server,this.port],[null]]),this.reconnections=0,this.reconnectTimer=this.reconnectInterval,this.pingLoop=setInterval(()=>{this._isConnected()&&this.ws.send("PING"),this.latency=new Date,this.pingTimeout=setTimeout(()=>{this.ws!==null&&(this.wasCloseCalled=!1,this.log.error("Ping timeout."),this.ws.close(),clearInterval(this.pingLoop),clearTimeout(this.pingTimeout),clearTimeout(this._updateEmotesetsTimer))},h.get(this.opts.connection.timeout,9999))},6e4);let l=h.get(this.opts.options.joinInterval,2e3);l<300&&(l=300);const m=new D(l),x=[...new Set([...this.opts.channels,...this.channels])];this.channels=[];for(let R=0;R<x.length;R++){const I=x[R];m.add(()=>{this._isConnected()&&this.join(I).catch(M=>this.log.error(M))})}m.next();break}case"NOTICE":{const l=[null],m=[n,w,c],x=[w],R=[n,!0],I=[n,!1],M=[m,l],C=[m,x],f=`[${n}] ${c}`;switch(w){case"subs_on":this.log.info(`[${n}] This room is now in subscribers-only mode.`),this.emits(["subscriber","subscribers","_promiseSubscribers"],[R,R,l]);break;case"subs_off":this.log.info(`[${n}] This room is no longer in subscribers-only mode.`),this.emits(["subscriber","subscribers","_promiseSubscribersoff"],[I,I,l]);break;case"emote_only_on":this.log.info(`[${n}] This room is now in emote-only mode.`),this.emits(["emoteonly","_promiseEmoteonly"],[R,l]);break;case"emote_only_off":this.log.info(`[${n}] This room is no longer in emote-only mode.`),this.emits(["emoteonly","_promiseEmoteonlyoff"],[I,l]);break;case"slow_on":case"slow_off":break;case"followers_on_zero":case"followers_on":case"followers_off":break;case"r9k_on":this.log.info(`[${n}] This room is now in r9k mode.`),this.emits(["r9kmode","r9kbeta","_promiseR9kbeta"],[R,R,l]);break;case"r9k_off":this.log.info(`[${n}] This room is no longer in r9k mode.`),this.emits(["r9kmode","r9kbeta","_promiseR9kbetaoff"],[I,I,l]);break;case"room_mods":{const P=c.split(": "),q=(P.length>1?P[1]:"").toLowerCase().split(", ").filter(k=>k);this.emits(["_promiseMods","mods"],[[null,q],[n,q]]);break}case"no_mods":this.emits(["_promiseMods","mods"],[[null,[]],[n,[]]]);break;case"vips_success":{c.endsWith(".")&&(c=c.slice(0,-1));const P=c.split(": "),q=(P.length>1?P[1]:"").toLowerCase().split(", ").filter(k=>k);this.emits(["_promiseVips","vips"],[[null,q],[n,q]]);break}case"no_vips":this.emits(["_promiseVips","vips"],[[null,[]],[n,[]]]);break;case"already_banned":case"bad_ban_admin":case"bad_ban_anon":case"bad_ban_broadcaster":case"bad_ban_global_mod":case"bad_ban_mod":case"bad_ban_self":case"bad_ban_staff":case"usage_ban":this.log.info(f),this.emits(["notice","_promiseBan"],C);break;case"ban_success":this.log.info(f),this.emits(["notice","_promiseBan"],M);break;case"usage_clear":this.log.info(f),this.emits(["notice","_promiseClear"],C);break;case"usage_mods":this.log.info(f),this.emits(["notice","_promiseMods"],[m,[w,[]]]);break;case"mod_success":this.log.info(f),this.emits(["notice","_promiseMod"],M);break;case"usage_vips":this.log.info(f),this.emits(["notice","_promiseVips"],[m,[w,[]]]);break;case"usage_vip":case"bad_vip_grantee_banned":case"bad_vip_grantee_already_vip":case"bad_vip_max_vips_reached":case"bad_vip_achievement_incomplete":this.log.info(f),this.emits(["notice","_promiseVip"],[m,[w,[]]]);break;case"vip_success":this.log.info(f),this.emits(["notice","_promiseVip"],M);break;case"usage_mod":case"bad_mod_banned":case"bad_mod_mod":this.log.info(f),this.emits(["notice","_promiseMod"],C);break;case"unmod_success":this.log.info(f),this.emits(["notice","_promiseUnmod"],M);break;case"unvip_success":this.log.info(f),this.emits(["notice","_promiseUnvip"],M);break;case"usage_unmod":case"bad_unmod_mod":this.log.info(f),this.emits(["notice","_promiseUnmod"],C);break;case"usage_unvip":case"bad_unvip_grantee_not_vip":this.log.info(f),this.emits(["notice","_promiseUnvip"],C);break;case"color_changed":this.log.info(f),this.emits(["notice","_promiseColor"],M);break;case"usage_color":case"turbo_only_color":this.log.info(f),this.emits(["notice","_promiseColor"],C);break;case"commercial_success":this.log.info(f),this.emits(["notice","_promiseCommercial"],M);break;case"usage_commercial":case"bad_commercial_error":this.log.info(f),this.emits(["notice","_promiseCommercial"],C);break;case"hosts_remaining":{this.log.info(f);const P=isNaN(c[0])?0:parseInt(c[0]);this.emits(["notice","_promiseHost"],[m,[null,~~P]]);break}case"bad_host_hosting":case"bad_host_rate_exceeded":case"bad_host_error":case"usage_host":this.log.info(f),this.emits(["notice","_promiseHost"],[m,[w,null]]);break;case"already_r9k_on":case"usage_r9k_on":this.log.info(f),this.emits(["notice","_promiseR9kbeta"],C);break;case"already_r9k_off":case"usage_r9k_off":this.log.info(f),this.emits(["notice","_promiseR9kbetaoff"],C);break;case"timeout_success":this.log.info(f),this.emits(["notice","_promiseTimeout"],M);break;case"delete_message_success":this.log.info(`[${n} ${c}]`),this.emits(["notice","_promiseDeletemessage"],M);break;case"already_subs_off":case"usage_subs_off":this.log.info(f),this.emits(["notice","_promiseSubscribersoff"],C);break;case"already_subs_on":case"usage_subs_on":this.log.info(f),this.emits(["notice","_promiseSubscribers"],C);break;case"already_emote_only_off":case"usage_emote_only_off":this.log.info(f),this.emits(["notice","_promiseEmoteonlyoff"],C);break;case"already_emote_only_on":case"usage_emote_only_on":this.log.info(f),this.emits(["notice","_promiseEmoteonly"],C);break;case"usage_slow_on":this.log.info(f),this.emits(["notice","_promiseSlow"],C);break;case"usage_slow_off":this.log.info(f),this.emits(["notice","_promiseSlowoff"],C);break;case"usage_timeout":case"bad_timeout_admin":case"bad_timeout_anon":case"bad_timeout_broadcaster":case"bad_timeout_duration":case"bad_timeout_global_mod":case"bad_timeout_mod":case"bad_timeout_self":case"bad_timeout_staff":this.log.info(f),this.emits(["notice","_promiseTimeout"],C);break;case"untimeout_success":case"unban_success":this.log.info(f),this.emits(["notice","_promiseUnban"],M);break;case"usage_unban":case"bad_unban_no_ban":this.log.info(f),this.emits(["notice","_promiseUnban"],C);break;case"usage_delete":case"bad_delete_message_error":case"bad_delete_message_broadcaster":case"bad_delete_message_mod":this.log.info(f),this.emits(["notice","_promiseDeletemessage"],C);break;case"usage_unhost":case"not_hosting":this.log.info(f),this.emits(["notice","_promiseUnhost"],C);break;case"whisper_invalid_login":case"whisper_invalid_self":case"whisper_limit_per_min":case"whisper_limit_per_sec":case"whisper_restricted":case"whisper_restricted_recipient":this.log.info(f),this.emits(["notice","_promiseWhisper"],C);break;case"no_permission":case"msg_banned":case"msg_room_not_found":case"msg_channel_suspended":case"tos_ban":case"invalid_user":this.log.info(f),this.emits(["notice","_promiseBan","_promiseClear","_promiseUnban","_promiseTimeout","_promiseDeletemessage","_promiseMods","_promiseMod","_promiseUnmod","_promiseVips","_promiseVip","_promiseUnvip","_promiseCommercial","_promiseHost","_promiseUnhost","_promiseJoin","_promisePart","_promiseR9kbeta","_promiseR9kbetaoff","_promiseSlow","_promiseSlowoff","_promiseFollowers","_promiseFollowersoff","_promiseSubscribers","_promiseSubscribersoff","_promiseEmoteonly","_promiseEmoteonlyoff","_promiseWhisper"],[m,[w,n]]);break;case"msg_rejected":case"msg_rejected_mandatory":this.log.info(f),this.emit("automod",n,w,c);break;case"unrecognized_cmd":this.log.info(f),this.emit("notice",n,w,c);break;case"cmds_available":case"host_target_went_offline":case"msg_censored_broadcaster":case"msg_duplicate":case"msg_emoteonly":case"msg_verified_email":case"msg_ratelimit":case"msg_subsonly":case"msg_timedout":case"msg_bad_characters":case"msg_channel_blocked":case"msg_facebook":case"msg_followersonly":case"msg_followersonly_followed":case"msg_followersonly_zero":case"msg_slowmode":case"msg_suspended":case"no_help":case"usage_disconnect":case"usage_help":case"usage_me":case"unavailable_command":this.log.info(f),this.emit("notice",n,w,c);break;case"host_on":case"host_off":break;default:c.includes("Login unsuccessful")||c.includes("Login authentication failed")?(this.wasCloseCalled=!1,this.reconnect=!1,this.reason=c,this.log.error(this.reason),this.ws.close()):c.includes("Error logging in")||c.includes("Improperly formatted auth")?(this.wasCloseCalled=!1,this.reconnect=!1,this.reason=c,this.log.error(this.reason),this.ws.close()):c.includes("Invalid NICK")?(this.wasCloseCalled=!1,this.reconnect=!1,this.reason="Invalid NICK.",this.log.error(this.reason),this.ws.close()):(this.log.warn(`Could not parse NOTICE from tmi.twitch.tv:
${JSON.stringify(r,null,4)}`),this.emit("notice",n,w,c));break}break}case"USERNOTICE":{const l=b["display-name"]||b.login,m=b["msg-param-sub-plan"]||"",x=h.unescapeIRC(h.get(b["msg-param-sub-plan-name"],""))||null,I={prime:m.includes("Prime"),plan:m,planName:x},M=~~(b["msg-param-streak-months"]||0),C=b["msg-param-recipient-display-name"]||b["msg-param-recipient-user-name"],f=~~b["msg-param-mass-gift-count"];switch(b["message-type"]=w,w){case"resub":this.emits(["resub","subanniversary"],[[n,l,M,c,b,I]]);break;case"sub":this.emits(["subscription","sub"],[[n,l,I,c,b]]);break;case"subgift":this.emit("subgift",n,l,M,C,I,b);break;case"anonsubgift":this.emit("anonsubgift",n,M,C,I,b);break;case"submysterygift":this.emit("submysterygift",n,l,f,I,b);break;case"anonsubmysterygift":this.emit("anonsubmysterygift",n,f,I,b);break;case"primepaidupgrade":this.emit("primepaidupgrade",n,l,I,b);break;case"giftpaidupgrade":{const P=b["msg-param-sender-name"]||b["msg-param-sender-login"];this.emit("giftpaidupgrade",n,l,P,b);break}case"anongiftpaidupgrade":this.emit("anongiftpaidupgrade",n,l,b);break;case"raid":{const P=b["msg-param-displayName"]||b["msg-param-login"],q=+b["msg-param-viewerCount"];this.emit("raided",n,P,q,b);break}case"ritual":{const P=b["msg-param-ritual-name"];switch(P){case"new_chatter":this.emit("newchatter",n,l,b,c);break;default:this.emit("ritual",P,n,l,b,c);break}break}default:this.emit("usernotice",w,n,b,c);break}break}case"HOSTTARGET":{const l=c.split(" "),m=~~l[1]||0;l[0]==="-"?(this.log.info(`[${n}] Exited host mode.`),this.emits(["unhost","_promiseUnhost"],[[n,m],[null]])):(this.log.info(`[${n}] Now hosting ${l[0]} for ${m} viewer(s).`),this.emit("hosting",n,l[0],m));break}case"CLEARCHAT":if(r.params.length>1){const l=h.get(r.tags["ban-duration"],null);l===null?(this.log.info(`[${n}] ${c} has been banned.`),this.emit("ban",n,c,null,r.tags)):(this.log.info(`[${n}] ${c} has been timed out for ${l} seconds.`),this.emit("timeout",n,c,null,~~l,r.tags))}else this.log.info(`[${n}] Chat was cleared by a moderator.`),this.emits(["clearchat","_promiseClear"],[[n],[null]]);break;case"CLEARMSG":if(r.params.length>1){const l=c,m=b.login;b["message-type"]="messagedeleted",this.log.info(`[${n}] ${m}'s message has been deleted.`),this.emit("messagedeleted",n,m,l,b)}break;case"RECONNECT":this.log.info("Received RECONNECT request from Twitch.."),this.log.info(`Disconnecting and reconnecting in ${Math.round(this.reconnectTimer/1e3)} seconds..`),this.disconnect().catch(l=>this.log.error(l)),setTimeout(()=>this.connect().catch(l=>this.log.error(l)),this.reconnectTimer);break;case"USERSTATE":r.tags.username=this.username,r.tags["user-type"]==="mod"&&(this.moderators[n]||(this.moderators[n]=[]),this.moderators[n].includes(this.username)||this.moderators[n].push(this.username)),!h.isJustinfan(this.getUsername())&&!this.userstate[n]&&(this.userstate[n]=b,this.lastJoined=n,this.channels.push(n),this.log.info(`Joined ${n}`),this.emit("join",n,h.username(this.getUsername()),!0)),r.tags["emote-sets"]!==this.emotes&&this._updateEmoteset(r.tags["emote-sets"]),this.userstate[n]=b;break;case"GLOBALUSERSTATE":this.globaluserstate=b,this.emit("globaluserstate",b),typeof r.tags["emote-sets"]<"u"&&this._updateEmoteset(r.tags["emote-sets"]);break;case"ROOMSTATE":if(h.channel(this.lastJoined)===n&&this.emit("_promiseJoin",null,n),r.tags.channel=n,this.emit("roomstate",n,r.tags),!h.hasOwn(r.tags,"subs-only")){if(h.hasOwn(r.tags,"slow"))if(typeof r.tags.slow=="boolean"&&!r.tags.slow){const l=[n,!1,0];this.log.info(`[${n}] This room is no longer in slow mode.`),this.emits(["slow","slowmode","_promiseSlowoff"],[l,l,[null]])}else{const l=~~r.tags.slow,m=[n,!0,l];this.log.info(`[${n}] This room is now in slow mode.`),this.emits(["slow","slowmode","_promiseSlow"],[m,m,[null]])}if(h.hasOwn(r.tags,"followers-only"))if(r.tags["followers-only"]==="-1"){const l=[n,!1,0];this.log.info(`[${n}] This room is no longer in followers-only mode.`),this.emits(["followersonly","followersmode","_promiseFollowersoff"],[l,l,[null]])}else{const l=~~r.tags["followers-only"],m=[n,!0,l];this.log.info(`[${n}] This room is now in follower-only mode.`),this.emits(["followersonly","followersmode","_promiseFollowers"],[m,m,[null]])}}break;case"SERVERCHANGE":break;default:this.log.warn(`Could not parse message from tmi.twitch.tv:
${JSON.stringify(r,null,4)}`);break}else if(r.prefix==="jtv")switch(r.command){case"MODE":c==="+o"?(this.moderators[n]||(this.moderators[n]=[]),this.moderators[n].includes(r.params[2])||this.moderators[n].push(r.params[2]),this.emit("mod",n,r.params[2])):c==="-o"&&(this.moderators[n]||(this.moderators[n]=[]),this.moderators[n].filter(l=>l!==r.params[2]),this.emit("unmod",n,r.params[2]));break;default:this.log.warn(`Could not parse message from jtv:
${JSON.stringify(r,null,4)}`);break}else switch(r.command){case"353":this.emit("names",r.params[2],r.params[3].split(" "));break;case"366":break;case"JOIN":{const l=r.prefix.split("!")[0];h.isJustinfan(this.getUsername())&&this.username===l&&(this.lastJoined=n,this.channels.push(n),this.log.info(`Joined ${n}`),this.emit("join",n,l,!0)),this.username!==l&&this.emit("join",n,l,!1);break}case"PART":{let l=!1;const m=r.prefix.split("!")[0];if(this.username===m){l=!0,this.userstate[n]&&delete this.userstate[n];let x=this.channels.indexOf(n);x!==-1&&this.channels.splice(x,1),x=this.opts.channels.indexOf(n),x!==-1&&this.opts.channels.splice(x,1),this.log.info(`Left ${n}`),this.emit("_promisePart",null)}this.emit("part",n,m,l);break}case"WHISPER":{const l=r.prefix.split("!")[0];this.log.info(`[WHISPER] <${l}>: ${c}`),h.hasOwn(r.tags,"username")||(r.tags.username=l),r.tags["message-type"]="whisper";const m=h.channel(r.tags.username);this.emits(["whisper","message"],[[m,r.tags,c,!1]]);break}case"PRIVMSG":if(r.tags.username=r.prefix.split("!")[0],r.tags.username==="jtv"){const l=h.username(c.split(" ")[0]),m=c.includes("auto");if(c.includes("hosting you for")){const x=h.extractNumber(c);this.emit("hosted",n,l,x,m)}else c.includes("hosting you")&&this.emit("hosted",n,l,0,m)}else{const l=h.get(this.opts.options.messagesLogLevel,"info"),m=h.actionMessage(c);if(r.tags["message-type"]=m?"action":"chat",c=m?m[1]:c,h.hasOwn(r.tags,"bits"))this.emit("cheer",n,r.tags,c);else{if(h.hasOwn(r.tags,"msg-id")){if(r.tags["msg-id"]==="highlighted-message"){const x=r.tags["msg-id"];this.emit("redeem",n,r.tags.username,x,r.tags,c)}else if(r.tags["msg-id"]==="skip-subs-mode-message"){const x=r.tags["msg-id"];this.emit("redeem",n,r.tags.username,x,r.tags,c)}}else if(h.hasOwn(r.tags,"custom-reward-id")){const x=r.tags["custom-reward-id"];this.emit("redeem",n,r.tags.username,x,r.tags,c)}m?(this.log[l](`[${n}] *<${r.tags.username}>: ${c}`),this.emits(["action","message"],[[n,r.tags,c,!1]])):(this.log[l](`[${n}] <${r.tags.username}>: ${c}`),this.emits(["chat","message"],[[n,r.tags,c,!1]]))}}break;default:this.log.warn(`Could not parse message:
${JSON.stringify(r,null,4)}`);break}},T.prototype.connect=function(){return new Promise((r,n)=>{this.server=h.get(this.opts.connection.server,"irc-ws.chat.twitch.tv"),this.port=h.get(this.opts.connection.port,80),this.secure&&(this.port=443),this.port===443&&(this.secure=!0),this.reconnectTimer=this.reconnectTimer*this.reconnectDecay,this.reconnectTimer>=this.maxReconnectInterval&&(this.reconnectTimer=this.maxReconnectInterval),this._openConnection(),this.once("_promiseConnect",c=>{c?n(c):r([this.server,~~this.port])})})},T.prototype._openConnection=function(){const r=`${this.secure?"wss":"ws"}://${this.server}:${this.port}/`,n={};"agent"in this.opts.connection&&(n.agent=this.opts.connection.agent),this.ws=new s(r,"irc",n),this.ws.onmessage=this._onMessage.bind(this),this.ws.onerror=this._onError.bind(this),this.ws.onclose=this._onClose.bind(this),this.ws.onopen=this._onOpen.bind(this)},T.prototype._onOpen=function(){this._isConnected()&&(this.log.info(`Connecting to ${this.server} on port ${this.port}..`),this.emit("connecting",this.server,~~this.port),this.username=h.get(this.opts.identity.username,h.justinfan()),this._getToken().then(r=>{const n=h.password(r);this.log.info("Sending authentication to server.."),this.emit("logon");let c="twitch.tv/tags twitch.tv/commands";this._skipMembership||(c+=" twitch.tv/membership"),this.ws.send("CAP REQ :"+c),n?this.ws.send(`PASS ${n}`):h.isJustinfan(this.username)&&this.ws.send("PASS SCHMOOPIIE"),this.ws.send(`NICK ${this.username}`)}).catch(r=>{this.emits(["_promiseConnect","disconnected"],[[r],["Could not get a token."]])}))},T.prototype._getToken=function(){const r=this.opts.identity.password;let n;return typeof r=="function"?(n=r(),n instanceof Promise?n:Promise.resolve(n)):Promise.resolve(r)},T.prototype._onMessage=function(r){r.data.trim().split(`\r
`).forEach(c=>{const w=g.msg(c);w&&this.handleMessage(w)})},T.prototype._onError=function(){this.moderators={},this.userstate={},this.globaluserstate={},clearInterval(this.pingLoop),clearTimeout(this.pingTimeout),clearTimeout(this._updateEmotesetsTimer),this.reason=this.ws===null?"Connection closed.":"Unable to connect.",this.emits(["_promiseConnect","disconnected"],[[this.reason]]),this.reconnect&&this.reconnections===this.maxReconnectAttempts&&(this.emit("maxreconnect"),this.log.error("Maximum reconnection attempts reached.")),this.reconnect&&!this.reconnecting&&this.reconnections<=this.maxReconnectAttempts-1&&(this.reconnecting=!0,this.reconnections=this.reconnections+1,this.log.error(`Reconnecting in ${Math.round(this.reconnectTimer/1e3)} seconds..`),this.emit("reconnect"),setTimeout(()=>{this.reconnecting=!1,this.connect().catch(r=>this.log.error(r))},this.reconnectTimer)),this.ws=null},T.prototype._onClose=function(){this.moderators={},this.userstate={},this.globaluserstate={},clearInterval(this.pingLoop),clearTimeout(this.pingTimeout),clearTimeout(this._updateEmotesetsTimer),this.wasCloseCalled?(this.wasCloseCalled=!1,this.reason="Connection closed.",this.log.info(this.reason),this.emits(["_promiseConnect","_promiseDisconnect","disconnected"],[[this.reason],[null],[this.reason]])):(this.emits(["_promiseConnect","disconnected"],[[this.reason]]),this.reconnect&&this.reconnections===this.maxReconnectAttempts&&(this.emit("maxreconnect"),this.log.error("Maximum reconnection attempts reached.")),this.reconnect&&!this.reconnecting&&this.reconnections<=this.maxReconnectAttempts-1&&(this.reconnecting=!0,this.reconnections=this.reconnections+1,this.log.error(`Could not connect to server. Reconnecting in ${Math.round(this.reconnectTimer/1e3)} seconds..`),this.emit("reconnect"),setTimeout(()=>{this.reconnecting=!1,this.connect().catch(r=>this.log.error(r))},this.reconnectTimer))),this.ws=null},T.prototype._getPromiseDelay=function(){return this.currentLatency<=600?600:this.currentLatency+100},T.prototype._sendCommand=function(r,n,c,w){return new Promise((b,l)=>{if(this._isConnected())(r===null||typeof r=="number")&&(r===null&&(r=this._getPromiseDelay()),h.promiseDelay(r).then(()=>l("No response from Twitch.")));else return l("Not connected to server.");if(n!==null){const m=h.channel(n);this.log.info(`[${m}] Executing command: ${c}`),this.ws.send(`PRIVMSG ${m} :${c}`)}else this.log.info(`Executing command: ${c}`),this.ws.send(c);typeof w=="function"?w(b,l):b()})},T.prototype._sendMessage=function(r,n,c,w){return new Promise((b,l)=>{if(this._isConnected()){if(h.isJustinfan(this.getUsername()))return l("Cannot send anonymous messages.")}else return l("Not connected to server.");const m=h.channel(n);if(this.userstate[m]||(this.userstate[m]={}),c.length>=500){const C=h.splitLine(c,500);c=C[0],setTimeout(()=>{this._sendMessage(r,n,C[1],()=>{})},350)}this.ws.send(`PRIVMSG ${m} :${c}`);const x={};Object.keys(this.emotesets).forEach(C=>this.emotesets[C].forEach(f=>(h.isRegex(f.code)?g.emoteRegex:g.emoteString)(c,f.code,f.id,x)));const R=Object.assign(this.userstate[m],g.emotes({emotes:g.transformEmotes(x)||null})),I=h.get(this.opts.options.messagesLogLevel,"info"),M=h.actionMessage(c);M?(R["message-type"]="action",this.log[I](`[${m}] *<${this.getUsername()}>: ${M[1]}`),this.emits(["action","message"],[[m,R,M[1],!0]])):(R["message-type"]="chat",this.log[I](`[${m}] <${this.getUsername()}>: ${c}`),this.emits(["chat","message"],[[m,R,c,!0]])),typeof w=="function"?w(b,l):b()})},T.prototype._updateEmoteset=function(r){let n=r!==void 0;if(n&&(r===this.emotes?n=!1:this.emotes=r),this._skipUpdatingEmotesets){n&&this.emit("emotesets",r,{});return}const c=()=>{this._updateEmotesetsTimerDelay>0&&(clearTimeout(this._updateEmotesetsTimer),this._updateEmotesetsTimer=setTimeout(()=>this._updateEmoteset(r),this._updateEmotesetsTimerDelay))};this._getToken().then(w=>{const b=`https://api.twitch.tv/kraken/chat/emoticon_images?emotesets=${r}`,l={};return"fetchAgent"in this.opts.connection&&(l.agent=this.opts.connection.fetchAgent),i(b,{...l,headers:{Accept:"application/vnd.twitchtv.v5+json",Authorization:`OAuth ${h.token(w)}`,"Client-ID":this.clientId}})}).then(w=>w.json()).then(w=>{this.emotesets=w.emoticon_sets||{},this.emit("emotesets",r,this.emotesets),c()}).catch(()=>c())},T.prototype.getUsername=function(){return this.username},T.prototype.getOptions=function(){return this.opts},T.prototype.getChannels=function(){return this.channels},T.prototype.isMod=function(r,n){const c=h.channel(r);return this.moderators[c]||(this.moderators[c]=[]),this.moderators[c].includes(h.username(n))},T.prototype.readyState=function(){return this.ws===null?"CLOSED":["CONNECTING","OPEN","CLOSING","CLOSED"][this.ws.readyState]},T.prototype._isConnected=function(){return this.ws!==null&&this.ws.readyState===1},T.prototype.disconnect=function(){return new Promise((r,n)=>{this.ws!==null&&this.ws.readyState!==3?(this.wasCloseCalled=!0,this.log.info("Disconnecting from server.."),this.ws.close(),this.once("_promiseDisconnect",()=>r([this.server,~~this.port]))):(this.log.error("Cannot disconnect from server. Socket is not opened or connection is already closing."),n("Cannot disconnect from server. Socket is not opened or connection is already closing."))})},T.prototype.off=T.prototype.removeListener,e.exports&&(e.exports=T),typeof window<"u"&&(window.tmi={client:T,Client:T})})(Re);var nt=Re.exports;const Oe=nt;var ot={client:Oe,Client:Oe};const rt=ge(ot);/*!
 * mustache.js - Logic-less {{mustache}} templates with JavaScript
 * http://github.com/janl/mustache.js
 */var at=Object.prototype.toString,ee=Array.isArray||function(t){return at.call(t)==="[object Array]"};function _e(e){return typeof e=="function"}function ct(e){return ee(e)?"array":typeof e}function de(e){return e.replace(/[\-\[\]{}()*+?.,\\\^$|#\s]/g,"\\$&")}function Me(e,t){return e!=null&&typeof e=="object"&&t in e}function lt(e,t){return e!=null&&typeof e!="object"&&e.hasOwnProperty&&e.hasOwnProperty(t)}var ht=RegExp.prototype.test;function ut(e,t){return ht.call(e,t)}var ft=/\S/;function mt(e){return!ut(ft,e)}var dt={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;","/":"&#x2F;","`":"&#x60;","=":"&#x3D;"};function pt(e){return String(e).replace(/[&<>"'`=\/]/g,function(s){return dt[s]})}var gt=/\s*/,_t=/\s+/,De=/\s*=/,bt=/\s*\}/,vt=/#|\^|\/|>|\{|&|=|!/;function wt(e,t){if(!e)return[];var s=!1,i=[],o=[],a=[],u=!1,p=!1,g="",D=0;function h(){if(u&&!p)for(;a.length;)delete o[a.pop()];else a=[];u=!1,p=!1}var L,T,S;function r(M){if(typeof M=="string"&&(M=M.split(_t,2)),!ee(M)||M.length!==2)throw new Error("Invalid tags: "+M);L=new RegExp(de(M[0])+"\\s*"),T=new RegExp("\\s*"+de(M[1])),S=new RegExp("\\s*"+de("}"+M[1]))}r(t||Y.tags);for(var n=new ae(e),c,w,b,l,m,x;!n.eos();){if(c=n.pos,b=n.scanUntil(L),b)for(var R=0,I=b.length;R<I;++R)l=b.charAt(R),mt(l)?(a.push(o.length),g+=l):(p=!0,s=!0,g+=" "),o.push(["text",l,c,c+1]),c+=1,l===`
`&&(h(),g="",D=0,s=!1);if(!n.scan(L))break;if(u=!0,w=n.scan(vt)||"name",n.scan(gt),w==="="?(b=n.scanUntil(De),n.scan(De),n.scanUntil(T)):w==="{"?(b=n.scanUntil(S),n.scan(bt),n.scanUntil(T),w="&"):b=n.scanUntil(T),!n.scan(T))throw new Error("Unclosed tag at "+n.pos);if(w==">"?m=[w,b,c,n.pos,g,D,s]:m=[w,b,c,n.pos],D++,o.push(m),w==="#"||w==="^")i.push(m);else if(w==="/"){if(x=i.pop(),!x)throw new Error('Unopened section "'+b+'" at '+c);if(x[1]!==b)throw new Error('Unclosed section "'+x[1]+'" at '+c)}else w==="name"||w==="{"||w==="&"?p=!0:w==="="&&r(b)}if(h(),x=i.pop(),x)throw new Error('Unclosed section "'+x[1]+'" at '+n.pos);return $t(yt(o))}function yt(e){for(var t=[],s,i,o=0,a=e.length;o<a;++o)s=e[o],s&&(s[0]==="text"&&i&&i[0]==="text"?(i[1]+=s[1],i[3]=s[3]):(t.push(s),i=s));return t}function $t(e){for(var t=[],s=t,i=[],o,a,u=0,p=e.length;u<p;++u)switch(o=e[u],o[0]){case"#":case"^":s.push(o),i.push(o),s=o[4]=[];break;case"/":a=i.pop(),a[5]=o[2],s=i.length>0?i[i.length-1][4]:t;break;default:s.push(o)}return t}function ae(e){this.string=e,this.tail=e,this.pos=0}ae.prototype.eos=function(){return this.tail===""};ae.prototype.scan=function(t){var s=this.tail.match(t);if(!s||s.index!==0)return"";var i=s[0];return this.tail=this.tail.substring(i.length),this.pos+=i.length,i};ae.prototype.scanUntil=function(t){var s=this.tail.search(t),i;switch(s){case-1:i=this.tail,this.tail="";break;case 0:i="";break;default:i=this.tail.substring(0,s),this.tail=this.tail.substring(s)}return this.pos+=i.length,i};function K(e,t){this.view=e,this.cache={".":this.view},this.parent=t}K.prototype.push=function(t){return new K(t,this)};K.prototype.lookup=function(t){var s=this.cache,i;if(s.hasOwnProperty(t))i=s[t];else{for(var o=this,a,u,p,g=!1;o;){if(t.indexOf(".")>0)for(a=o.view,u=t.split("."),p=0;a!=null&&p<u.length;)p===u.length-1&&(g=Me(a,u[p])||lt(a,u[p])),a=a[u[p++]];else a=o.view[t],g=Me(o.view,t);if(g){i=a;break}o=o.parent}s[t]=i}return _e(i)&&(i=i.call(this.view)),i};function W(){this.templateCache={_cache:{},set:function(t,s){this._cache[t]=s},get:function(t){return this._cache[t]},clear:function(){this._cache={}}}}W.prototype.clearCache=function(){typeof this.templateCache<"u"&&this.templateCache.clear()};W.prototype.parse=function(t,s){var i=this.templateCache,o=t+":"+(s||Y.tags).join(":"),a=typeof i<"u",u=a?i.get(o):void 0;return u==null&&(u=wt(t,s),a&&i.set(o,u)),u};W.prototype.render=function(t,s,i,o){var a=this.getConfigTags(o),u=this.parse(t,a),p=s instanceof K?s:new K(s,void 0);return this.renderTokens(u,p,i,t,o)};W.prototype.renderTokens=function(t,s,i,o,a){for(var u="",p,g,D,h=0,L=t.length;h<L;++h)D=void 0,p=t[h],g=p[0],g==="#"?D=this.renderSection(p,s,i,o,a):g==="^"?D=this.renderInverted(p,s,i,o,a):g===">"?D=this.renderPartial(p,s,i,a):g==="&"?D=this.unescapedValue(p,s):g==="name"?D=this.escapedValue(p,s,a):g==="text"&&(D=this.rawValue(p)),D!==void 0&&(u+=D);return u};W.prototype.renderSection=function(t,s,i,o,a){var u=this,p="",g=s.lookup(t[1]);function D(T){return u.render(T,s,i,a)}if(g){if(ee(g))for(var h=0,L=g.length;h<L;++h)p+=this.renderTokens(t[4],s.push(g[h]),i,o,a);else if(typeof g=="object"||typeof g=="string"||typeof g=="number")p+=this.renderTokens(t[4],s.push(g),i,o,a);else if(_e(g)){if(typeof o!="string")throw new Error("Cannot use higher-order sections without the original template");g=g.call(s.view,o.slice(t[3],t[5]),D),g!=null&&(p+=g)}else p+=this.renderTokens(t[4],s,i,o,a);return p}};W.prototype.renderInverted=function(t,s,i,o,a){var u=s.lookup(t[1]);if(!u||ee(u)&&u.length===0)return this.renderTokens(t[4],s,i,o,a)};W.prototype.indentPartial=function(t,s,i){for(var o=s.replace(/[^ \t]/g,""),a=t.split(`
`),u=0;u<a.length;u++)a[u].length&&(u>0||!i)&&(a[u]=o+a[u]);return a.join(`
`)};W.prototype.renderPartial=function(t,s,i,o){if(i){var a=this.getConfigTags(o),u=_e(i)?i(t[1]):i[t[1]];if(u!=null){var p=t[6],g=t[5],D=t[4],h=u;g==0&&D&&(h=this.indentPartial(u,D,p));var L=this.parse(h,a);return this.renderTokens(L,s,i,h,o)}}};W.prototype.unescapedValue=function(t,s){var i=s.lookup(t[1]);if(i!=null)return i};W.prototype.escapedValue=function(t,s,i){var o=this.getConfigEscape(i)||Y.escape,a=s.lookup(t[1]);if(a!=null)return typeof a=="number"&&o===Y.escape?String(a):o(a)};W.prototype.rawValue=function(t){return t[1]};W.prototype.getConfigTags=function(t){return ee(t)?t:t&&typeof t=="object"?t.tags:void 0};W.prototype.getConfigEscape=function(t){if(t&&typeof t=="object"&&!ee(t))return t.escape};var Y={name:"mustache.js",version:"4.2.0",tags:["{{","}}"],clearCache:void 0,escape:void 0,parse:void 0,render:void 0,Scanner:void 0,Context:void 0,Writer:void 0,set templateCache(e){oe.templateCache=e},get templateCache(){return oe.templateCache}},oe=new W;Y.clearCache=function(){return oe.clearCache()};Y.parse=function(t,s){return oe.parse(t,s)};Y.render=function(t,s,i,o){if(typeof t!="string")throw new TypeError('Invalid template! Template should be a "string" but "'+ct(t)+'" was given as the first argument for mustache#render(template, view, partials)');return oe.render(t,s,i,o)};Y.escape=pt;Y.Scanner=ae;Y.Context=K;Y.Writer=W;var Pe={exports:{}};(function(e,t){(function(s,i){e.exports=i()})(ue,function(){var s=1e3,i=6e4,o=36e5,a="millisecond",u="second",p="minute",g="hour",D="day",h="week",L="month",T="quarter",S="year",r="date",n="Invalid Date",c=/^(\d{4})[-/]?(\d{1,2})?[-/]?(\d{0,2})[Tt\s]*(\d{1,2})?:?(\d{1,2})?:?(\d{1,2})?[.:]?(\d+)?$/,w=/\[([^\]]+)]|Y{1,4}|M{1,4}|D{1,2}|d{1,4}|H{1,2}|h{1,2}|a|A|m{1,2}|s{1,2}|Z{1,2}|SSS/g,b={name:"en",weekdays:"Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),months:"January_February_March_April_May_June_July_August_September_October_November_December".split("_"),ordinal:function(k){var v=["th","st","nd","rd"],d=k%100;return"["+k+(v[(d-20)%10]||v[d]||v[0])+"]"}},l=function(k,v,d){var y=String(k);return!y||y.length>=v?k:""+Array(v+1-y.length).join(d)+k},m={s:l,z:function(k){var v=-k.utcOffset(),d=Math.abs(v),y=Math.floor(d/60),_=d%60;return(v<=0?"+":"-")+l(y,2,"0")+":"+l(_,2,"0")},m:function k(v,d){if(v.date()<d.date())return-k(d,v);var y=12*(d.year()-v.year())+(d.month()-v.month()),_=v.clone().add(y,L),E=d-_<0,O=v.clone().add(y+(E?-1:1),L);return+(-(y+(d-_)/(E?_-O:O-_))||0)},a:function(k){return k<0?Math.ceil(k)||0:Math.floor(k)},p:function(k){return{M:L,y:S,w:h,d:D,D:r,h:g,m:p,s:u,ms:a,Q:T}[k]||String(k||"").toLowerCase().replace(/s$/,"")},u:function(k){return k===void 0}},x="en",R={};R[x]=b;var I=function(k){return k instanceof P},M=function k(v,d,y){var _;if(!v)return x;if(typeof v=="string"){var E=v.toLowerCase();R[E]&&(_=E),d&&(R[E]=d,_=E);var O=v.split("-");if(!_&&O.length>1)return k(O[0])}else{var N=v.name;R[N]=v,_=N}return!y&&_&&(x=_),_||!y&&x},C=function(k,v){if(I(k))return k.clone();var d=typeof v=="object"?v:{};return d.date=k,d.args=arguments,new P(d)},f=m;f.l=M,f.i=I,f.w=function(k,v){return C(k,{locale:v.$L,utc:v.$u,x:v.$x,$offset:v.$offset})};var P=function(){function k(d){this.$L=M(d.locale,null,!0),this.parse(d)}var v=k.prototype;return v.parse=function(d){this.$d=function(y){var _=y.date,E=y.utc;if(_===null)return new Date(NaN);if(f.u(_))return new Date;if(_ instanceof Date)return new Date(_);if(typeof _=="string"&&!/Z$/i.test(_)){var O=_.match(c);if(O){var N=O[2]-1||0,A=(O[7]||"0").substring(0,3);return E?new Date(Date.UTC(O[1],N,O[3]||1,O[4]||0,O[5]||0,O[6]||0,A)):new Date(O[1],N,O[3]||1,O[4]||0,O[5]||0,O[6]||0,A)}}return new Date(_)}(d),this.$x=d.x||{},this.init()},v.init=function(){var d=this.$d;this.$y=d.getFullYear(),this.$M=d.getMonth(),this.$D=d.getDate(),this.$W=d.getDay(),this.$H=d.getHours(),this.$m=d.getMinutes(),this.$s=d.getSeconds(),this.$ms=d.getMilliseconds()},v.$utils=function(){return f},v.isValid=function(){return this.$d.toString()!==n},v.isSame=function(d,y){var _=C(d);return this.startOf(y)<=_&&_<=this.endOf(y)},v.isAfter=function(d,y){return C(d)<this.startOf(y)},v.isBefore=function(d,y){return this.endOf(y)<C(d)},v.$g=function(d,y,_){return f.u(d)?this[y]:this.set(_,d)},v.unix=function(){return Math.floor(this.valueOf()/1e3)},v.valueOf=function(){return this.$d.getTime()},v.startOf=function(d,y){var _=this,E=!!f.u(y)||y,O=f.p(d),N=function(B,F){var V=f.w(_.$u?Date.UTC(_.$y,F,B):new Date(_.$y,F,B),_);return E?V:V.endOf(D)},A=function(B,F){return f.w(_.toDate()[B].apply(_.toDate("s"),(E?[0,0,0,0]:[23,59,59,999]).slice(F)),_)},j=this.$W,H=this.$M,J=this.$D,Q="set"+(this.$u?"UTC":"");switch(O){case S:return E?N(1,0):N(31,11);case L:return E?N(1,H):N(0,H+1);case h:var z=this.$locale().weekStart||0,te=(j<z?j+7:j)-z;return N(E?J-te:J+(6-te),H);case D:case r:return A(Q+"Hours",0);case g:return A(Q+"Minutes",1);case p:return A(Q+"Seconds",2);case u:return A(Q+"Milliseconds",3);default:return this.clone()}},v.endOf=function(d){return this.startOf(d,!1)},v.$set=function(d,y){var _,E=f.p(d),O="set"+(this.$u?"UTC":""),N=(_={},_[D]=O+"Date",_[r]=O+"Date",_[L]=O+"Month",_[S]=O+"FullYear",_[g]=O+"Hours",_[p]=O+"Minutes",_[u]=O+"Seconds",_[a]=O+"Milliseconds",_)[E],A=E===D?this.$D+(y-this.$W):y;if(E===L||E===S){var j=this.clone().set(r,1);j.$d[N](A),j.init(),this.$d=j.set(r,Math.min(this.$D,j.daysInMonth())).$d}else N&&this.$d[N](A);return this.init(),this},v.set=function(d,y){return this.clone().$set(d,y)},v.get=function(d){return this[f.p(d)]()},v.add=function(d,y){var _,E=this;d=Number(d);var O=f.p(y),N=function(H){var J=C(E);return f.w(J.date(J.date()+Math.round(H*d)),E)};if(O===L)return this.set(L,this.$M+d);if(O===S)return this.set(S,this.$y+d);if(O===D)return N(1);if(O===h)return N(7);var A=(_={},_[p]=i,_[g]=o,_[u]=s,_)[O]||1,j=this.$d.getTime()+d*A;return f.w(j,this)},v.subtract=function(d,y){return this.add(-1*d,y)},v.format=function(d){var y=this,_=this.$locale();if(!this.isValid())return _.invalidDate||n;var E=d||"YYYY-MM-DDTHH:mm:ssZ",O=f.z(this),N=this.$H,A=this.$m,j=this.$M,H=_.weekdays,J=_.months,Q=_.meridiem,z=function(F,V,se,ce){return F&&(F[V]||F(y,E))||se[V].slice(0,ce)},te=function(F){return f.s(N%12||12,F,"0")},B=Q||function(F,V,se){var ce=F<12?"AM":"PM";return se?ce.toLowerCase():ce};return E.replace(w,function(F,V){return V||function(se){switch(se){case"YY":return String(y.$y).slice(-2);case"YYYY":return f.s(y.$y,4,"0");case"M":return j+1;case"MM":return f.s(j+1,2,"0");case"MMM":return z(_.monthsShort,j,J,3);case"MMMM":return z(J,j);case"D":return y.$D;case"DD":return f.s(y.$D,2,"0");case"d":return String(y.$W);case"dd":return z(_.weekdaysMin,y.$W,H,2);case"ddd":return z(_.weekdaysShort,y.$W,H,3);case"dddd":return H[y.$W];case"H":return String(N);case"HH":return f.s(N,2,"0");case"h":return te(1);case"hh":return te(2);case"a":return B(N,A,!0);case"A":return B(N,A,!1);case"m":return String(A);case"mm":return f.s(A,2,"0");case"s":return String(y.$s);case"ss":return f.s(y.$s,2,"0");case"SSS":return f.s(y.$ms,3,"0");case"Z":return O}return null}(F)||O.replace(":","")})},v.utcOffset=function(){return 15*-Math.round(this.$d.getTimezoneOffset()/15)},v.diff=function(d,y,_){var E,O=this,N=f.p(y),A=C(d),j=(A.utcOffset()-this.utcOffset())*i,H=this-A,J=function(){return f.m(O,A)};switch(N){case S:E=J()/12;break;case L:E=J();break;case T:E=J()/3;break;case h:E=(H-j)/6048e5;break;case D:E=(H-j)/864e5;break;case g:E=H/o;break;case p:E=H/i;break;case u:E=H/s;break;default:E=H}return _?E:f.a(E)},v.daysInMonth=function(){return this.endOf(L).$D},v.$locale=function(){return R[this.$L]},v.locale=function(d,y){if(!d)return this.$L;var _=this.clone(),E=M(d,y,!0);return E&&(_.$L=E),_},v.clone=function(){return f.w(this.$d,this)},v.toDate=function(){return new Date(this.valueOf())},v.toJSON=function(){return this.isValid()?this.toISOString():null},v.toISOString=function(){return this.$d.toISOString()},v.toString=function(){return this.$d.toUTCString()},k}(),q=P.prototype;return C.prototype=q,[["$ms",a],["$s",u],["$m",p],["$H",g],["$W",D],["$M",L],["$y",S],["$D",r]].forEach(function(k){q[k[1]]=function(v){return this.$g(v,k[0],k[1])}}),C.extend=function(k,v){return k.$i||(k(v,P,C),k.$i=!0),C},C.locale=M,C.isDayjs=I,C.unix=function(k){return C(1e3*k)},C.en=R[x],C.Ls=R,C.p={},C})})(Pe);var Ct=Pe.exports;const he=ge(Ct);var je={exports:{}};(function(e,t){(function(s,i){e.exports=i()})(ue,function(){return function(s,i,o){i.prototype.dayOfYear=function(a){var u=Math.round((o(this).startOf("day")-o(this).startOf("year"))/864e5)+1;return a==null?u:this.add(a-u,"day")}}})})(je);var kt=je.exports;const Tt=ge(kt);he.extend(Tt);const Le="bd18p9eycculb64acrdjjdp72bt4xr",St="🎉 Hey @{{viewerName}}, it's your Followversary! You followed on this day {{yearCount}} {{yearLabel}} ago.",ie={currentDayOfYear:-1,followers:{}};function Et(e,t,s=St,i,o){const a=new rt.Client({identity:{username:i||e,password:t},channels:[e]});return async function(){await a.connect().catch(()=>{console.error("Unable to connect to Twitch via tmi.js")});const p=await fetch(`https://api.twitch.tv/helix/users/?login=${e}`,{headers:{Authorization:`Bearer ${t.replace("oauth:","")}`,"Client-ID":Le}});if(!p.ok){console.error("Broadcaster data could not be fetched");return}const D=(await p.json()).data[0].id;a.on("message",async(h,L,T,S)=>{if(S)return;const r=o&&T==="!debug";if(h===L.username&&!r)return;const n=he().dayOfYear();if(n!==ie.currentDayOfYear&&(ie.currentDayOfYear=n,ie.followers={}),ie.followers[L.username||L["user-id"]||""]&&!r)return;const c=`https://api.twitch.tv/helix/channels/followers?broadcaster_id=${D}&user_id=${L["user-id"]}&scope=moderator:read:followers`;console.log({fetchUrl:c});const w=await fetch(c,{headers:{Authorization:`Bearer ${t.replace("oauth:","")}`,"Client-ID":Le}});if(!w.ok){console.error("Fetch result failed. Possibly bad token",w.status,await w.json());return}const b=await w.json();ie.followers[L.username||L["user-id"]||""]=!0;const l=b.data[0]?.followed_at;if(!l&&!r){console.log("User is not following");return}const m=he(l);if(n!==m.dayOfYear()&&!r)return;const x=Math.abs(m.diff(he(),"year"));if(x<1&&!r)return;const R=x===1?"year":"years",I={viewerName:L.username,yearCount:x,yearLabel:R},M=Y.render(s,I);a.say(h,M)})}(),function(){a.disconnect()}}export{Le as C,St as d,Et as s};
